From 28460427c5b92f71db71213b918e0f49ddf46db4 Mon Sep 17 00:00:00 2001
From: Portisch <hugo.portisch@yahoo.de>
Date: Fri, 14 Apr 2023 11:19:44 +0200
Subject: [PATCH 2/2] AMLCodec: add user setting player LED Added the option
 when display LED and player LED mode is supported by the display.

---
 .../resources/strings.po                       | 12 +++++++++++-
 system/settings/settings.xml                   |  6 ++++++
 .../VideoPlayer/DVDCodecs/Video/AMLCodec.cpp   | 12 ++++++++++++
 xbmc/settings/Settings.cpp                     |  1 +
 xbmc/settings/Settings.h                       |  1 +
 xbmc/windowing/amlogic/WinSystemAmlogic.cpp    | 18 ++++++++++++++++++
 xbmc/windowing/amlogic/WinSystemAmlogic.h      |  2 ++
 7 files changed, 51 insertions(+), 1 deletion(-)

diff --git a/addons/resource.language.en_gb/resources/strings.po b/addons/resource.language.en_gb/resources/strings.po
index a0e3c1ecf9..17295d8e8c 100644
--- a/addons/resource.language.en_gb/resources/strings.po
+++ b/addons/resource.language.en_gb/resources/strings.po
@@ -8677,7 +8677,17 @@ msgctxt "#14297"
 msgid "Use this option to disable Dolby Vision support if available."
 msgstr ""
 
-#empty strings from id 14296 to 14300
+#: system/settings/settings.xml
+msgctxt "#14298"
+msgid "Use Player LED"
+msgstr ""
+
+#: system/settings/settings.xml
+msgctxt "#14299"
+msgid "Use player LED mode (422, 12bit) instead display LED (RGB, 8bit) for Dolby Vision."
+msgstr ""
+
+#empty strings from id 14300 to 14300
 
 #. pvr "channels" settings group label
 #: system/settings/settings.xml
diff --git a/system/settings/settings.xml b/system/settings/settings.xml
index 96dce71b60..0973f03006 100755
--- a/system/settings/settings.xml
+++ b/system/settings/settings.xml
@@ -3719,6 +3719,12 @@
           <default>false</default>
           <control type="toggle" />
         </setting>
+        <setting id="coreelec.amlogic.useplayerled" type="boolean" label="14298" help="14299">
+          <requirement>HAVE_AMCODEC</requirement>
+          <visible>false</visible>
+          <default>false</default>
+          <control type="toggle" />
+        </setting>
       </group>
     </category>
     <category id="cache" label="439" help="36399">
diff --git a/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp b/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp
index 23f6446afb..6a74852fdf 100644
--- a/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp
+++ b/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp
@@ -291,6 +291,8 @@ typedef struct hdr_buf {
     int size;
 } hdr_buf_t;
 
+#define FLAG_FORCE_DV_LL        (unsigned int)(0x4000)
+
 typedef struct am_packet {
     AVPacket      avpkt;
     uint64_t      avpts;
@@ -2006,6 +2008,16 @@ bool CAMLCodec::OpenDecoder(CDVDStreamInfo &hints)
     // enable Dolby Vision
     CSysfsPath("/sys/module/aml_media/parameters/dolby_vision_enable", 1);
 
+    // force player LED mode when enabled
+    CSysfsPath dolby_vision_flags{"/sys/module/aml_media/parameters/dolby_vision_flags"};
+    if (dolby_vision_flags.Exists())
+    {
+      if (CServiceBroker::GetSettingsComponent()->GetSettings()->GetBool(CSettings::SETTING_COREELEC_AMLOGIC_USE_PLAYERLED))
+        dolby_vision_flags.Set(dolby_vision_flags.Get<unsigned int>() | FLAG_FORCE_DV_LL);
+      else
+        dolby_vision_flags.Set(dolby_vision_flags.Get<unsigned int>() & ~(FLAG_FORCE_DV_LL));
+    }
+
     am_private->gcodec.dv_enable = 1;
     if (hints.dovi.dv_profile == 7 && CServiceBroker::GetSettingsComponent()->GetSettings()->GetInt(
         CSettings::SETTING_VIDEOPLAYER_CONVERTDOVI) == 0)
diff --git a/xbmc/settings/Settings.cpp b/xbmc/settings/Settings.cpp
index 3ecf2fbafc..08777c7bc7 100644
--- a/xbmc/settings/Settings.cpp
+++ b/xbmc/settings/Settings.cpp
@@ -440,6 +440,7 @@ constexpr const char* CSettings::SETTING_COREELEC_AMLOGIC_LIMIT_CD;
 constexpr const char* CSettings::SETTING_COREELEC_AMLOGIC_FORCE_CS;
 constexpr const char* CSettings::SETTING_COREELEC_AMLOGIC_DISABLEGUISCALING;
 constexpr const char* CSettings::SETTING_COREELEC_AMLOGIC_DV_DISABLE;
+constexpr const char* CSettings::SETTING_COREELEC_AMLOGIC_USE_PLAYERLED;
 constexpr const char* CSettings::SETTING_CACHE_HARDDISK;
 constexpr const char* CSettings::SETTING_CACHEVIDEO_DVDROM;
 constexpr const char* CSettings::SETTING_CACHEVIDEO_LAN;
diff --git a/xbmc/settings/Settings.h b/xbmc/settings/Settings.h
index 4ef19c5731..e7c65adfe2 100644
--- a/xbmc/settings/Settings.h
+++ b/xbmc/settings/Settings.h
@@ -445,6 +445,7 @@ public:
   static constexpr auto SETTING_COREELEC_AMLOGIC_FORCE_CS = "coreelec.amlogic.forcecs";
   static constexpr auto SETTING_COREELEC_AMLOGIC_DISABLEGUISCALING = "coreelec.amlogic.disableguiscaling";
   static constexpr auto SETTING_COREELEC_AMLOGIC_DV_DISABLE = "coreelec.amlogic.disabledolbyvision";
+  static constexpr auto SETTING_COREELEC_AMLOGIC_USE_PLAYERLED = "coreelec.amlogic.useplayerled";
   static constexpr auto SETTING_CACHE_HARDDISK = "cache.harddisk";
   static constexpr auto SETTING_CACHEVIDEO_DVDROM = "cachevideo.dvdrom";
   static constexpr auto SETTING_CACHEVIDEO_LAN = "cachevideo.lan";
diff --git a/xbmc/windowing/amlogic/WinSystemAmlogic.cpp b/xbmc/windowing/amlogic/WinSystemAmlogic.cpp
index 8f0a5de2f4..a45b9e10a6 100644
--- a/xbmc/windowing/amlogic/WinSystemAmlogic.cpp
+++ b/xbmc/windowing/amlogic/WinSystemAmlogic.cpp
@@ -99,6 +99,13 @@ bool CWinSystemAmlogic::InitWindowSystem()
       settings->SetBool(CSettings::SETTING_COREELEC_AMLOGIC_DV_DISABLE, false);
     }
 
+    setting = settings->GetSetting(CSettings::SETTING_COREELEC_AMLOGIC_USE_PLAYERLED);
+    if (setting)
+    {
+      setting->SetVisible(false);
+      settings->SetBool(CSettings::SETTING_COREELEC_AMLOGIC_USE_PLAYERLED, false);
+    }
+
     setting = settings->GetSetting(CSettings::SETTING_VIDEOPLAYER_CONVERTDOVI);
     if (setting)
     {
@@ -106,6 +113,17 @@ bool CWinSystemAmlogic::InitWindowSystem()
       settings->SetInt(CSettings::SETTING_VIDEOPLAYER_CONVERTDOVI, 2);
     }
   }
+  else
+  {
+    int dv_cap = aml_get_drmProperty("dv_cap", DRM_MODE_OBJECT_CONNECTOR);
+    CLog::Log(LOGDEBUG, "CWinSystemAmlogic::InitWindowSystem -- got display dv_cap: {:d}", dv_cap);
+    if (dv_cap != -1 && ((dv_cap & LL_YCbCr_422_12BIT) != 0))
+    {
+      auto setting = settings->GetSetting(CSettings::SETTING_COREELEC_AMLOGIC_USE_PLAYERLED);
+      if (setting)
+        setting->SetVisible(true);
+    }
+  }
 
   m_nativeDisplay = EGL_DEFAULT_DISPLAY;
 
diff --git a/xbmc/windowing/amlogic/WinSystemAmlogic.h b/xbmc/windowing/amlogic/WinSystemAmlogic.h
index 2c70086caa..5c19b87cf6 100644
--- a/xbmc/windowing/amlogic/WinSystemAmlogic.h
+++ b/xbmc/windowing/amlogic/WinSystemAmlogic.h
@@ -16,6 +16,8 @@
 #include "system_egl.h"
 #include <EGL/fbdev_window.h>
 
+#define LL_YCbCr_422_12BIT  (int)(1<<5)
+
 class IDispResource;
 
 class CWinSystemAmlogic : public CWinSystemBase
-- 
2.39.1

